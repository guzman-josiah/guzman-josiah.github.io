<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gallery">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23007aff' width='100' height='100'/><text y='70' x='50' text-anchor='middle' font-size='60'>üì∏</text></svg>">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Gallery&quot;,&quot;short_name&quot;:&quot;Gallery&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;}">
    <title>Gallery</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f7; }
        .header { background: #007aff; color: white; padding: 15px; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 20px; margin-bottom: 10px; }
        .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .btn { background: white; color: #007aff; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .btn-primary { background: #34c759; color: white; }
        .btn-warning { background: #ff9500; color: white; }
        .btn-small { padding: 6px 12px; font-size: 13px; }
        .container { padding: 15px; max-width: 1200px; margin: 0 auto; position: relative; }
        .view-toggle { position: fixed; bottom: 20px; right: 20px; z-index: 50; }
        .view-btn { width: 56px; height: 56px; border-radius: 50%; background: #007aff; color: white; border: none; font-size: 24px; box-shadow: 0 4px 12px rgba(0,122,255,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .view-btn:active { transform: scale(0.95); }
        .view-menu { position: absolute; bottom: 70px; right: 0; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: none; flex-direction: column; overflow: hidden; }
        .view-menu.show { display: flex; }
        .view-option { padding: 15px 20px; border: none; background: white; text-align: left; font-size: 16px; cursor: pointer; border-bottom: 1px solid #e5e5e7; }
        .view-option:last-child { border-bottom: none; }
        .view-option:active { background: #f0f8ff; }
        .view-option.active { background: #e5f2ff; font-weight: 600; }
        .install-prompt { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,122,255,0.95); color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 200; max-width: 90%; text-align: center; display: none; }
        .install-prompt.show { display: block; animation: slideDown 0.3s; }
        .install-prompt button { background: white; color: #007aff; border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; margin-top: 10px; cursor: pointer; }
        .install-close { position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.3); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 16px; }
        @keyframes slideDown { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .search-container { padding: 10px 15px; background: white; border-bottom: 1px solid #e5e5e7; }
        .search-wrapper { position: relative; }
        .search-input { width: 100%; padding: 10px 40px 10px 35px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; }
        .search-input:focus { outline: none; border-color: #007aff; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px; }
        .search-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #d1d1d6; border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: none; }
        .search-clear.show { display: block; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d1d6; border-top: none; border-radius: 0 0 10px 10px; max-height: 300px; overflow-y: auto; display: none; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .search-results.show { display: block; }
        .search-result-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: #f8f9fa; }
        .search-result-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 6px; }
        .search-result-text { flex: 1; min-width: 0; }
        .search-result-name { font-weight: 600; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .search-result-desc { font-size: 12px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .grid { display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
        .grid-small { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card-image { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .card-body { padding: 12px; }
        .card-title { font-weight: 600; margin-bottom: 8px; }
        .card-actions { display: flex; gap: 6px; flex-wrap: wrap; }
        .list-item { background: white; border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; gap: 12px; }
        .list-image { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .list-content { flex: 1; }
        .list-actions { display: flex; flex-direction: column; gap: 6px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e5e5e7; font-size: 20px; font-weight: 600; }
        .modal-body { padding: 20px; }
        .modal-image { width: 100%; border-radius: 12px; margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; }
        .form-input, .form-textarea { width: 100%; padding: 10px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 16px; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .modal-actions { padding: 20px; border-top: 1px solid #e5e5e7; display: flex; gap: 10px; justify-content: flex-end; }
        .hidden { display: none; }
        .success { background: #34c759; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .success.show { display: block; }
        .empty { text-align: center; padding: 60px 20px; color: #666; }
        select { background: white; color: #007aff; border: none; padding: 8px 12px; border-radius: 8px; font-size: 14px; }
        .share-option { padding: 15px; border: 2px solid #e5e5e7; border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .share-option:active { border-color: #007aff; background: #f0f8ff; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì∏ Gallery</h1>
        <div class="toolbar">
            <select id="groupSel"></select>
            <button class="btn btn-warning btn-small" id="manageBtn">‚öôÔ∏è Manage</button>
        </div>
        <div class="toolbar">
            <input type="file" id="fileIn" accept="image/*" class="hidden">
            <input type="file" id="cameraIn" accept="image/*" capture="environment" class="hidden">
            <input type="file" id="importIn" accept=".json" class="hidden">
            <button class="btn btn-primary" id="addBtn">+ Add</button>
            <button class="btn btn-primary" id="camBtn">üì∑ Camera</button>
        </div>
    </div>
    
    <div class="install-prompt" id="installPrompt">
        <button class="install-close" onclick="closeInstallPrompt()">√ó</button>
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">üì≤ Install Gallery App</div>
        <div style="font-size: 14px; margin-bottom: 10px;">Add to your home screen for easy access!</div>
        <button onclick="showInstallGuide()">Show Me How</button>
    </div>
    
    <div class="search-container" id="searchContainer" style="display: none;">
        <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Search images..." autocomplete="off" oninput="app.handleSearch()" onfocus="if(this.value) app.handleSearch()" onkeyup="if(event.key==='Enter') document.getElementById('searchResults').classList.remove('show')">
            <button class="search-clear" id="searchClear" onclick="app.clearSearch()">√ó</button>
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>
    
    <div class="container">
        <div id="msg" class="success"></div>
        <div id="gallery"></div>
    </div>
    
    <div class="view-toggle">
        <div class="view-menu" id="viewMenu">
            <button class="view-option" id="bigOpt">üìè Big Grid</button>
            <button class="view-option" id="smallOpt">üî≤ Small Grid</button>
            <button class="view-option" id="listOpt">üìã List View</button>
        </div>
        <button class="view-btn" id="viewBtn">‚ò∞</button>
    </div>
    
    <div id="addMod" class="modal"><div class="modal-content"><div class="modal-header" id="addTitle">Add</div><div class="modal-body"><img id="prev" class="modal-image hidden"><div class="form-group"><label class="form-label">Name</label><input id="name" class="form-input"></div><div class="form-group"><label class="form-label">Description</label><textarea id="desc" class="form-textarea"></textarea></div></div><div class="modal-actions"><button class="btn" id="cancelAdd">Cancel</button><button class="btn btn-primary" id="saveAdd">Save</button></div></div></div>
    
    <div id="viewMod" class="modal"><div class="modal-content"><div class="modal-header" id="viewTitle"></div><div class="modal-body"><img id="viewImg" class="modal-image"><div class="form-label">DESCRIPTION</div><div id="viewDesc"></div></div><div class="modal-actions"><button class="btn" id="delView" style="background:#ff3b30;color:white">Delete</button><button class="btn" id="editView">Edit</button><button class="btn btn-primary" id="closeView">Close</button></div></div></div>
    
    <div id="manageMod" class="modal"><div class="modal-content"><div class="modal-header">Manage Gallery</div><div class="modal-body"><button class="btn" id="installBtn" style="background: rgba(0,122,255,0.1); color: #007aff; margin-bottom: 20px; display: none;">üì≤ Install App to Home Screen</button><div style="margin-bottom:25px"><b>üìÅ GROUPS</b></div><select id="groupSelModal" style="width:100%;margin-bottom:15px"></select><div class="form-group"><input id="newGrp" class="form-input" placeholder="New group name"></div><button class="btn btn-primary" id="createGrp" style="margin-bottom:10px">Create Group</button><button class="btn" id="delGrp" style="margin-bottom:30px">Delete Current Group</button><div style="margin:30px 0;border-top:2px solid #e5e5e7"></div><div style="margin-bottom:25px"><b>üì§ SHARE CURRENT GROUP</b></div><div class="share-option" id="exp"><b>üìÅ Export Group</b><div style="font-size:13px;color:#666">Save current group to share via AirDrop</div></div><div style="margin:30px 0;border-top:2px solid #e5e5e7"></div><div style="margin-bottom:25px"><b>üì• IMPORT</b></div><div class="share-option" id="imp"><b>üìÇ Import Group</b><div style="font-size:13px;color:#666">Add a group someone shared with you</div></div><div style="margin:30px 0;border-top:2px solid #e5e5e7"></div><div style="margin-bottom:25px"><b>‚òÅÔ∏è BACKUP</b></div><div class="share-option" id="backupCloud"><b>üíæ Backup All</b><div style="font-size:13px;color:#666">Save all groups to file</div></div><div class="share-option" id="restoreCloud"><b>üì• Restore All</b><div style="font-size:13px;color:#666">Restore from backup file</div></div></div><div class="modal-actions"><button class="btn btn-primary" id="closeManage">Close</button></div></div></div>

    <script>
        const app = {
            data: {},
            curr: 'default',
            view: 'big',
            imgData: null,
            vIdx: -1,
            eIdx: -1,
            
            start() {
                const saved = localStorage.getItem('galleryData');
                if (saved) try { this.data = JSON.parse(saved); } catch(e) {}
                if (!this.data.default) this.data.default = [];
                this.updSel();
                this.draw();
                this.bind();
                // Set initial active view
                document.getElementById('bigOpt').classList.add('active');
            },
            
            bind() {
                document.getElementById('addBtn').onclick = () => this.add();
                document.getElementById('camBtn').onclick = () => this.camera();
                document.getElementById('viewBtn').onclick = () => this.toggleViewMenu();
                document.getElementById('bigOpt').onclick = () => this.chView('big');
                document.getElementById('smallOpt').onclick = () => this.chView('small');
                document.getElementById('listOpt').onclick = () => this.chView('list');
                document.getElementById('manageBtn').onclick = () => this.opManage();
                document.getElementById('groupSel').onchange = () => this.swGrp();
                document.getElementById('cancelAdd').onclick = () => this.clAdd();
                document.getElementById('saveAdd').onclick = () => this.svImg();
                document.getElementById('closeView').onclick = () => this.clView();
                document.getElementById('editView').onclick = () => this.edCurr();
                document.getElementById('delView').onclick = () => this.delCurr();
                document.getElementById('createGrp').onclick = () => this.crGrp();
                document.getElementById('delGrp').onclick = () => this.delCurrGrp();
                document.getElementById('closeManage').onclick = () => this.clManage();
                document.getElementById('groupSelModal').onchange = () => this.swGrpModal();
                document.getElementById('exp').onclick = () => this.expFile();
                document.getElementById('imp').onclick = () => this.impFile();
                document.getElementById('backupCloud').onclick = () => this.backupCloud();
                document.getElementById('restoreCloud').onclick = () => this.restoreCloud();
                document.getElementById('fileIn').onchange = e => this.hdFile(e);
                document.getElementById('cameraIn').onchange = e => this.hdFile(e);
                document.getElementById('importIn').onchange = e => this.hdImpFile(e);
                
                // Close view menu when clicking outside
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('viewMenu');
                    const btn = document.getElementById('viewBtn');
                    if (!menu.contains(e.target) && e.target !== btn) {
                        menu.classList.remove('show');
                    }
                });
            },
            
            toggleViewMenu() {
                const menu = document.getElementById('viewMenu');
                menu.classList.toggle('show');
            },
            
            getImgs() {
                if (!this.data[this.curr]) this.data[this.curr] = [];
                return this.data[this.curr];
            },
            
            save() {
                localStorage.setItem('galleryData', JSON.stringify(this.data));
            },
            
            add() {
                this.eIdx = -1;
                document.getElementById('addTitle').textContent = 'Add Image';
                document.getElementById('saveAdd').textContent = 'Save';
                document.getElementById('fileIn').click();
            },
            
            camera() {
                this.eIdx = -1;
                document.getElementById('addTitle').textContent = 'Take Photo';
                document.getElementById('saveAdd').textContent = 'Save';
                document.getElementById('cameraIn').click();
            },
            
            hdFile(e) {
                const f = e.target.files[0];
                if (!f) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    this.imgData = ev.target.result;
                    const prev = document.getElementById('prev');
                    prev.src = this.imgData;
                    prev.classList.remove('hidden');
                    document.getElementById('name').value = f.name.split('.')[0];
                    document.getElementById('desc').value = '';
                    document.getElementById('addMod').classList.add('active');
                };
                reader.readAsDataURL(f);
                e.target.value = '';
            },
            
            svImg() {
                const n = document.getElementById('name').value.trim();
                const d = document.getElementById('desc').value.trim();
                if (!n) return alert('Enter name');
                const imgs = this.getImgs();
                if (this.eIdx >= 0) {
                    imgs[this.eIdx].name = n;
                    imgs[this.eIdx].description = d;
                    this.eIdx = -1;
                } else {
                    if (!this.imgData) return alert('No image');
                    imgs.push({id: Date.now(), name: n, description: d, data: this.imgData});
                }
                this.data[this.curr] = imgs;
                this.save();
                this.clAdd();
                this.draw();
                document.getElementById('fileIn').value = '';
                document.getElementById('cameraIn').value = '';
            },
            
            clAdd() {
                document.getElementById('addMod').classList.remove('active');
                this.imgData = null;
                this.eIdx = -1;
            },
            
            chView(v) {
                this.view = v;
                document.getElementById('viewMenu').classList.remove('show');
                // Update active state
                document.querySelectorAll('.view-option').forEach(opt => opt.classList.remove('active'));
                if (v === 'big') document.getElementById('bigOpt').classList.add('active');
                if (v === 'small') document.getElementById('smallOpt').classList.add('active');
                if (v === 'list') document.getElementById('listOpt').classList.add('active');
                this.draw();
            },
            
            draw(fromSearch = false) {
                const g = document.getElementById('gallery');
                g.innerHTML = '';
                const imgs = this.getImgs();
                
                // Show/hide search bar
                const searchContainer = document.getElementById('searchContainer');
                searchContainer.style.display = imgs.length > 0 ? 'block' : 'none';
                
                if (!imgs.length) {
                    g.innerHTML = '<div class="empty"><h2>No images</h2><p>Tap Add to start</p></div>';
                    this.buildSearchIndex();
                    return;
                }
                
                // Get search query
                const query = document.getElementById('searchInput').value.trim().toLowerCase();
                let imagesToShow = imgs;
                
                // Filter images if search is active
                if (query.length > 0) {
                    imagesToShow = [];
                    imgs.forEach((img, index) => {
                        const nameMatch = img.name.toLowerCase().includes(query);
                        const descMatch = (img.description || '').toLowerCase().includes(query);
                        if (nameMatch || descMatch) {
                            imagesToShow.push(img);
                        }
                    });
                    
                    if (imagesToShow.length === 0) {
                        g.innerHTML = '<div class="empty"><h2>No results</h2><p>No images match your search</p></div>';
                        if (!fromSearch) this.buildSearchIndex();
                        return;
                    }
                }
                
                if (this.view === 'list') {
                    imagesToShow.forEach((img) => {
                        const originalIndex = imgs.indexOf(img);
                        const d = document.createElement('div');
                        d.className = 'list-item';
                        d.innerHTML = `<img src="${img.data}" class="list-image"><div class="list-content"><div style="font-weight:600">${img.name}</div><div style="font-size:14px;color:#666">${img.description.substring(0, 80) || 'No desc'}</div></div><div class="list-actions"></div>`;
                        const a = d.querySelector('.list-actions');
                        this.addBtns(a, originalIndex);
                        g.appendChild(d);
                    });
                } else {
                    const dv = document.createElement('div');
                    dv.className = this.view === 'big' ? 'grid' : 'grid grid-small';
                    imagesToShow.forEach((img) => {
                        const originalIndex = imgs.indexOf(img);
                        const c = document.createElement('div');
                        c.className = 'card';
                        c.innerHTML = `<img src="${img.data}" class="card-image"><div class="card-body"><div class="card-title">${img.name}</div><div class="card-actions"></div></div>`;
                        const a = c.querySelector('.card-actions');
                        this.addBtns(a, originalIndex);
                        dv.appendChild(c);
                    });
                    g.appendChild(dv);
                }
                
                if (!fromSearch) this.buildSearchIndex();
            },
            
            addBtns(p, i) {
                const v = document.createElement('button');
                v.className = 'btn btn-small';
                v.textContent = 'View';
                v.onclick = () => this.viewImg(i);
                const e = document.createElement('button');
                e.className = 'btn btn-small';
                e.textContent = 'Edit';
                e.onclick = () => this.edImg(i);
                const d = document.createElement('button');
                d.className = 'btn btn-small';
                d.textContent = 'Del';
                d.onclick = () => this.delImg(i);
                p.append(v, e, d);
            },
            
            viewImg(i) {
                this.vIdx = i;
                const img = this.getImgs()[i];
                document.getElementById('viewTitle').textContent = img.name;
                document.getElementById('viewImg').src = img.data;
                document.getElementById('viewDesc').textContent = img.description || 'No description';
                document.getElementById('viewMod').classList.add('active');
            },
            
            clView() {
                document.getElementById('viewMod').classList.remove('active');
                this.vIdx = -1;
            },
            
            edCurr() {
                if (this.vIdx >= 0) this.edImg(this.vIdx);
                this.clView();
            },
            
            edImg(i) {
                const img = this.getImgs()[i];
                this.eIdx = i;
                this.imgData = img.data;
                document.getElementById('addTitle').textContent = 'Edit';
                document.getElementById('saveAdd').textContent = 'Update';
                document.getElementById('prev').src = img.data;
                document.getElementById('prev').classList.remove('hidden');
                document.getElementById('name').value = img.name;
                document.getElementById('desc').value = img.description;
                document.getElementById('addMod').classList.add('active');
            },
            
            delCurr() {
                if (this.vIdx >= 0) this.delImg(this.vIdx);
                this.clView();
            },
            
            delImg(i) {
                if (!confirm('Delete?')) return;
                const imgs = this.getImgs();
                imgs.splice(i, 1);
                this.data[this.curr] = imgs;
                this.save();
                this.draw();
            },
            
            opManage() {
                this.updModalSel();
                document.getElementById('manageMod').classList.add('active');
            },
            
            clManage() {
                document.getElementById('manageMod').classList.remove('active');
            },
            
            updModalSel() {
                const s = document.getElementById('groupSelModal');
                s.innerHTML = '<option value="default">Default</option>';
                Object.keys(this.data).forEach(k => {
                    if (!k.endsWith('_m') && k !== 'default') {
                        const o = document.createElement('option');
                        o.value = k;
                        o.textContent = this.data[k + '_m']?.name || k;
                        s.appendChild(o);
                    }
                });
                s.value = this.curr;
            },
            
            swGrpModal() {
                this.curr = document.getElementById('groupSelModal').value;
                document.getElementById('groupSel').value = this.curr;
                this.clearSearch();
            },
            
            crGrp() {
                const n = document.getElementById('newGrp').value.trim();
                if (!n) return alert('Enter name');
                const id = n.toLowerCase().replace(/\s+/g, '-');
                if (this.data[id]) return alert('Exists');
                this.data[id] = [];
                this.data[id + '_m'] = {name: n};
                this.save();
                this.curr = id;
                this.updSel();
                this.updModalSel();
                document.getElementById('newGrp').value = '';
                this.draw();
                this.showMsg('Group created!');
            },
            
            delCurrGrp() {
                if (this.curr === 'default') return alert('Cannot delete default group');
                if (!confirm('Delete current group and all its images?')) return;
                delete this.data[this.curr];
                delete this.data[this.curr + '_m'];
                this.curr = 'default';
                this.save();
                this.updSel();
                this.updModalSel();
                this.draw();
                this.showMsg('Group deleted!');
            },
            
            swGrp() {
                this.curr = document.getElementById('groupSel').value;
                this.clearSearch();
            },
            
            updSel() {
                const s = document.getElementById('groupSel');
                s.innerHTML = '<option value="default">Default</option>';
                Object.keys(this.data).forEach(k => {
                    if (!k.endsWith('_m') && k !== 'default') {
                        const o = document.createElement('option');
                        o.value = k;
                        o.textContent = this.data[k + '_m']?.name || k;
                        s.appendChild(o);
                    }
                });
                s.value = this.curr;
            },
            
            expFile() {
                const imgs = this.getImgs();
                const m = this.data[this.curr + '_m'] || {name: 'Gallery'};
                const exp = {groupName: m.name, images: imgs, exported: new Date().toISOString()};
                const blob = new Blob([JSON.stringify(exp)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gallery-${this.curr}-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showMsg('Exported! Share via AirDrop');
            },
            
            impFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => this.hdImpFile(e);
                input.click();
            },
            
            hdImpFile(e) {
                const f = e.target.files[0];
                if (!f) return;
                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        this.procImp(d);
                    } catch(e) {
                        alert('Invalid file');
                    }
                };
                reader.readAsText(f);
                e.target.value = '';
            },
            
            procImp(d) {
                if (!d.groupName || !d.images) return alert('Invalid format');
                const id = d.groupName.toLowerCase().replace(/\s+/g, '-');
                let finalId = id;
                let cnt = 1;
                while (this.data[finalId]) finalId = `${id}-${cnt++}`;
                this.data[finalId] = d.images;
                this.data[finalId + '_m'] = {name: d.groupName, imported: new Date().toISOString()};
                this.save();
                this.updSel();
                this.updModalSel();
                this.showMsg('Imported! Check dropdown');
            },
            
            showMsg(txt) {
                const m = document.getElementById('msg');
                m.textContent = txt;
                m.classList.add('show');
                setTimeout(() => m.classList.remove('show'), 3000);
            },
            
            backupCloud() {
                const backup = {
                    version: 1,
                    timestamp: new Date().toISOString(),
                    groups: this.data
                };
                const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gallery-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showMsg('Backup saved!');
            },
            
            restoreCloud() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const f = e.target.files[0];
                    if (!f) return;
                    const reader = new FileReader();
                    reader.onload = ev => {
                        try {
                            const backup = JSON.parse(ev.target.result);
                            if (!backup.groups) return alert('Invalid backup');
                            if (confirm('Replace all data?')) {
                                this.data = backup.groups;
                                this.curr = 'default';
                                this.save();
                                this.updSel();
                                this.updModalSel();
                                this.draw();
                                this.showMsg('Restored!');
                            }
                        } catch(e) {
                            alert('Invalid backup');
                        }
                    };
                    reader.readAsText(f);
                };
                input.click();
            },
            
            checkInstallPrompt() {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/CriOS|FxiOS/.test(navigator.userAgent);
                const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
                const promptDismissed = localStorage.getItem('installPromptDismissed');
                
                if (isIOS && isSafari && !isStandalone && !promptDismissed) {
                    setTimeout(() => {
                        document.getElementById('installPrompt').classList.add('show');
                    }, 2000);
                }
                
                if (isIOS && isSafari && !isStandalone) {
                    document.getElementById('installBtn').style.display = 'block';
                }
            },
            
            buildSearchIndex() {
                this.searchIndex = [];
                const imgs = this.getImgs();
                imgs.forEach((img, index) => {
                    this.searchIndex.push({
                        index: index,
                        name: img.name.toLowerCase(),
                        description: (img.description || '').toLowerCase(),
                        nameOriginal: img.name,
                        descOriginal: img.description || '',
                        data: img.data
                    });
                });
            },
            
            handleSearch() {
                const query = document.getElementById('searchInput').value.trim().toLowerCase();
                const clearBtn = document.getElementById('searchClear');
                const results = document.getElementById('searchResults');
                
                console.log('Search called, query:', query);
                
                clearBtn.classList.toggle('show', query.length > 0);
                
                // IMPORTANT: Redraw the gallery to show filtered results
                const g = document.getElementById('gallery');
                g.innerHTML = '';
                const imgs = this.getImgs();
                
                let imagesToShow = imgs;
                
                // Filter images if search is active
                if (query.length > 0) {
                    imagesToShow = [];
                    imgs.forEach((img, index) => {
                        const nameMatch = img.name.toLowerCase().includes(query);
                        const descMatch = (img.description || '').toLowerCase().includes(query);
                        if (nameMatch || descMatch) {
                            imagesToShow.push(img);
                        }
                    });
                    
                    if (imagesToShow.length === 0) {
                        g.innerHTML = '<div class="empty"><h2>No results</h2><p>No images match your search</p></div>';
                        results.classList.remove('show');
                        return;
                    }
                }
                
                // Rebuild gallery with filtered images
                if (this.view === 'list') {
                    imagesToShow.forEach((img) => {
                        const originalIndex = imgs.indexOf(img);
                        const d = document.createElement('div');
                        d.className = 'list-item';
                        d.innerHTML = `<img src="${img.data}" class="list-image"><div class="list-content"><div style="font-weight:600">${img.name}</div><div style="font-size:14px;color:#666">${img.description.substring(0, 80) || 'No desc'}</div></div><div class="list-actions"></div>`;
                        const a = d.querySelector('.list-actions');
                        this.addBtns(a, originalIndex);
                        g.appendChild(d);
                    });
                } else {
                    const dv = document.createElement('div');
                    dv.className = this.view === 'big' ? 'grid' : 'grid grid-small';
                    imagesToShow.forEach((img) => {
                        const originalIndex = imgs.indexOf(img);
                        const c = document.createElement('div');
                        c.className = 'card';
                        c.innerHTML = `<img src="${img.data}" class="card-image"><div class="card-body"><div class="card-title">${img.name}</div><div class="card-actions"></div></div>`;
                        const a = c.querySelector('.card-actions');
                        this.addBtns(a, originalIndex);
                        dv.appendChild(c);
                    });
                    g.appendChild(dv);
                }
                
                // Now handle dropdown
                if (query.length === 0) {
                    results.classList.remove('show');
                    return;
                }
                
                // Build dropdown suggestions
                const matches = this.searchIndex.filter(item => 
                    item.name.includes(query) || item.description.includes(query)
                ).slice(0, 5);
                
                console.log('Matches found:', matches.length);
                
                if (matches.length === 0) {
                    results.innerHTML = '<div style="padding:15px;color:#666;text-align:center">No suggestions</div>';
                    results.classList.add('show');
                    return;
                }
                
                results.innerHTML = '';
                matches.forEach(match => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    
                    const highlightText = (text, query) => {
                        if (!text) return '';
                        const index = text.toLowerCase().indexOf(query);
                        if (index === -1) return text;
                        return text.substring(0, index) + 
                               '<span style="background:#ffe066;font-weight:600">' + 
                               text.substring(index, index + query.length) + 
                               '</span>' + 
                               text.substring(index + query.length);
                    };
                    
                    const highlightedName = highlightText(match.nameOriginal, query);
                    const highlightedDesc = highlightText(match.descOriginal, query);
                    
                    item.innerHTML = `
                        <img src="${match.data}" class="search-result-thumb">
                        <div class="search-result-text">
                            <div class="search-result-name">${highlightedName}</div>
                            <div class="search-result-desc">${highlightedDesc || 'No description'}</div>
                        </div>
                    `;
                    item.onclick = () => {
                        this.viewImg(match.index);
                        results.classList.remove('show');
                    };
                    results.appendChild(item);
                });
                results.classList.add('show');
            },
            
            clearSearch() {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchClear').classList.remove('show');
                document.getElementById('searchResults').classList.remove('show');
                this.draw(false); // Don't pass true - we want to show all images
            }
        };
        
        function closeInstallPrompt() {
            document.getElementById('installPrompt').classList.remove('show');
            localStorage.setItem('installPromptDismissed', 'true');
        }
        
        function showInstallGuide() {
            closeInstallPrompt();
            alert('üì≤ How to Install:\n\n1. Tap the Share button (‚éô) at the bottom of Safari\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" in the top right\n4. The app icon will appear on your home screen!\n\nNote: The Share button is in the bottom center of Safari, between the back/forward arrows and tabs.');
        }
        
        window.onload = () => app.start();
    </script>
</body>
</html>